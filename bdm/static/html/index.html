<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="static/css/index.css" type="text/css"/>
        <script src="static/javascript/react/react.js"></script>
        <script src="static/javascript/react/JSXTransformer.js"></script>
        <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
        <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.4.2/pure-min.css">
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    </head>
    <body>
        <div id="hero-container" class="pure-g-r">
            <div class="or-spacer">
              <div class="mask"></div>
            </div>
        </div>

        <div id="container" class="pure-g-r">
            <div class="pure-u-7-24">
                <div class="pure-g">
                    <div class="pure-u-1-5">
                    </div>
                    <div class="pure-u-3-5">
                        <div id="donation-container" >
                        </div>
                    </div>
                </div>
            </div>
            <div id="paypal-container" class="pure-u-10-24">
                <div class="pure-g">
                    <div id="donation-text" class="pure-u-11-24">
                            <p>The Tempus Network provides TF2 Jump and CS:S Surf servers.</p>
                            <p>Donations help us pay for server bandwidth, hardware and maintenance; allowing the network to expand and plugin development to continue.</p>
                            <p>Donator benefits will be announced in the near future.</p>
                    </div>
                    <div class="pure-u-1-24">
                        <div id="divider">
                        </div>
                    </div>

                    <form class="pure-form pure-form-stacked pure-u-11-24" action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top" id="paypalForm">
                        <fieldset>
                            <legend>Donate with PayPal!</legend>
                            <label for="paypal-amount">Amount (USD)<label>
                            <input id="paypal-amount" name="amount" placeholder="50">

                            <label for="option-one" class="pure-radio">
                                <input id="option-one" type="radio" name="optionsRadios" value="single" checked>
                                Once-off Donation
                            </label>

                            <label for="option-two" class="pure-radio">
                                <input id="option-two" type="radio" name="optionsRadios" value="monthly" checked>
                                Monthly Subscription
                            </label>
                        </fieldset>

                        <fieldset>
                            SteamID (<a href="http://steamidfinder.com/">How do I find my steamID?</a>)
                            <input name="steamid" placeholder="STEAM_0:0:14265062">
                        </fieldset>

                        <label for="agree" class="pure-checkbox">
                            <input id="agree" type="checkbox"> Show donation as "Anonymous"
                        </label>

                        <fieldset>
                            <input type="submit" name="submit" alt="PayPal - The safer, easier way to pay online!" class="pure-button pure-button-primary" value="Donate">
                        </fieldset>

                        <input type="hidden" name="custom">
                        <input type="hidden" name="a3" value="0">
                        <input type="hidden" name="p3" value="1">
                        <input type="hidden" name="src" value="1">
                        <input type="hidden" name="t3" value="M">
                        <input type="hidden" name="item_name" value="Tempus Network Donation">
                        <input type="hidden" name="cmd" value="_donations">
                        <input type="hidden" name="business" value="WABA95A5Z3H4W">
                    </form>
                </div>
            </div>


            <div class="pure-u-7-24">
                <div class="pure-g">
                    <div class="pure-u-1-5">
                    </div>
                    <div id="server-status-container" class="pure-u-3-5">
                    </div>
                </div>
            </div>
        </div>
        <script type="text/jsx">
            /** @jsx React.DOM */

            var Throbber = React.createClass({
                render: function () {
                    return <img className="throbber" src="static/images/throbber.gif"/>
                }
            });


            var ServerStatus = React.createClass({
                render: function () {
                    return (
                    <div>
                    <ServerList servers={servers} url="api/servers" pollInterval={20}/>
                    </div>
                    )
                }
            });

            var Server = React.createClass({
                render: function() {
                    var flag = "static/images/flags/"+this.props.server.location+".png";

                    if (this.props.server.online) {
                        return (
                        <div className="server-status server-up">
                            <span className="server-players">
                                <span className="server-players-text">
                                    {this.props.server.player_count}/{this.props.server.max_players}
                                </span>
                            </span>
                            <span className="server-name">
                                <span className="server-name-text">
                                    {this.props.server.server_name}
                                </span>
                            </span>
                            <img className="server-location" src={flag} height="40" width="57"></img>
                        </div>)
                    }
                    else {
                        return (
                        <div className="server-status server-down">
                            <span className="server-name">{this.props.server.server_name}</span>
                        </div>)
                    }
                },

            });

            var ServerList = React.createClass({
                getInitialState: function() {
                    return {data: []};
                },

                dataReceived: function(data) {
                    this.setState({data: data.result});
                },

                serverError: function(xhr, status, err) {
                    console.error(this.props.url, status, xhr);
                },

                queryServer: function() {
                    $.ajax({
                        data: JSON.stringify(this.props.servers),
                        type: 'POST',
                        url: this.props.url,
                        dataType: 'json',
                        success: this.dataReceived,
                        error: this.serverError
                    });
                    console.log(this.props.servers);
                },

                componentWillMount: function() {
                    this.queryServer();
                    if (this.props.pollInterval > 0) {
                        setInterval(this.queryServer, this.props.pollInterval * 1000);
                    }
                },

                render: function() {
                    var serverNodes = this.state.data.map(function (server) {
                        return <Server server={server}></Server>
                    });
                    if (serverNodes.length == 0) {
                        return <Throbber />
                    }
                    return <div>{serverNodes}</div>
                }
            });

            var DonationList = React.createClass({
                render: function() {
                    var donationNodes = this.props.data.map(function (donation) {
                        return <Donation key={donation.date} donator={donation.personaname} amount={donation.amount} avatar={donation.avatar}></Donation>;
                    });
                    if (donationNodes.length == 0) {
                        return (
                            <div className="donation-list">
                                <div className="donation-list-title">
                                <span className="fa fa-trophy donation-list-icon"></span>
                                {this.props.title}
                                </div>
                                <Throbber />
                            </div>)
                    }
                    return (
                        <div className="donation-list">
                            <div className="donation-list-title">
                            <span className="fa fa-trophy donation-list-icon"></span>
                            {this.props.title}
                            </div>
                            {donationNodes}
                        </div>
                    );
                }
            });

            var Donation = React.createClass({
                render: function() {
                    if (!this.props.avatar) {
                        this.props.avatar = 'static/images/default_avatar.png';
                    }
                    return (
                        <div className="donation">
                            <img className="steam-avatar" src={this.props.avatar} height="34" width="34"/>
                            <div className="donator-name">
                                {this.props.donator}
                            </div>
                            <div className="donation-amount">
                                ${this.props.amount}
                            </div>
                        </div>
                    );
                }
            });

            var DonationBox = React.createClass({
                getInitialState: function() {
                    return {data: []};
                },
                loadDonationsFromServer: function() {
                    $.ajax({
                        url: this.props.url,
                        dataType: 'json',
                        success: function(data) {
                            this.setState({data: data.result});
                        }.bind(this),
                        error: function(xhr, status, err) {
                            console.error(this.props.url, status, xhr);
                        }.bind(this)
                    });
                },
                componentWillMount: function() {
                    this.loadDonationsFromServer();
                    if (this.props.pollInterval > 0) {
                        setInterval(this.loadDonationsFromServer, this.props.pollInterval * 1000);
                    }
                },

                render: function () {
                    return (
                    <DonationList title={this.props.title} data={this.state.data} />
                    );
                },

            });

            var DonationContainer = React.createClass({
                render: function () {
                    return (
                    <div>
                    <DonationBox title="Leaderboard" url="api/top" pollInterval={0}/>
                    <DonationBox title="Recent" url="api/recent" pollInterval={0}/>
                    </div>
                    )
                }
            });

         var servers = [
            ['27.50.72.82', 27020, 'AU'],
            ['74.91.122.222', 27015, 'US'],
            ['5.135.153.162', 27055, 'EU'],

            ['173.199.80.140', 27015, 'AU'],
            ['8.6.74.53', 27015, 'US'],
            ['41.86.100.101', 27015, 'ZA']]

            React.renderComponent(
                <DonationContainer/>,
                document.getElementById('donation-container'));
            React.renderComponent(
                <ServerStatus/>,
                document.getElementById('server-status-container'));

        </script>
    </body>
        <script type="text/javascript">
            $(document).ready(function () {
                function setCustomInput() {
                    var o = {"steamid": $('input[name="steamid"]', 'form').val(),
                             "anonymous": $('#agree', '#paypalForm').is(':checked')};
                    //$('input[name=optionsRadios]:checked', 'form').val()
                    $('input:hidden[name="custom"]', 'form').val(window.btoa(JSON.stringify(o)));
                }

                $('#paypalForm').submit(function () {
                    setCustomInput();

                    var donationType = $('input[name=optionsRadios]:checked', '#paypalForm').val();
                    if (donationType === 'monthly') {
                        $('input:hidden[name="cmd"]', '#paypalform').val('_xclick-subscriptions');
                    }
                    else if (donationType === 'single') {
                        $('input:hidden[name="cmd"]', '#paypalForm').val('_donations');
                    }

                    // Set a3 to amount. a3 is the amonut field used for _xclick-subscriptions.
                    $('input:hidden[name="a3"]', '#paypalForm').val(
                        $('input[name="amount"]', '#paypalForm').val());
                    return true;
                });
            })
        </script>
</html>
